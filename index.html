<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bibliothèque de Babel — index</title>

  <!-- Courier Prime (Google Fonts) -->
  <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="site-header">
    <a class="logo-link" href="index.html" aria-label="Accueil">
      <div class="logo">BABEL</div>
    </a>
    <h1 class="site-title">Bibliothèque de Babel — collection</h1>
  </header>

  <main>
    <section id="controls" class="controls">
      <label for="seed">Seed (génère les mêmes livres si identique):</label>
      <input id="seed" type="number" value="42" />
      <button id="regen">Régénérer</button>
      <p class="note">Caractères utilisés pour le texte : <code>abcdefghijklmnopqrstuvwxyz,. </code> (l'espace compte).</p>
    </section>

    <section id="books" class="books-grid" aria-live="polite">
      <!-- Les 10 livres seront injectés ici par JS -->
    </section>
  </main>

  <footer class="site-footer">
    <small>Projet — Bibliothèque de Babel — thème libre (travail en slam).</small>
  </footer>

  <script>
  // ---------- RNG seed function (mulberry32) ----------
  function mulberry32(seed) {
    let a = seed >>> 0;
    return function() {
      a = (a + 0x6D2B79F5) >>> 0;
      var t = a;
      t = Math.imul(t ^ (t >>> 15), t | 1);
      t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
      return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
    }
  }

  // characters allowed by spec
  const CHARS = "abcdefghijklmnopqrstuvwxyz,. ";

  // generate deterministic random string of length n using rng
  function genString(rng, n) {
    let s = "";
    for (let i = 0; i < n; i++) {
      s += CHARS[Math.floor(rng() * CHARS.length)];
    }
    // trim double spaces at ends and collapse & keep original spacing as allowed
    return s;
  }

  // generate one book object
  function genBook(rng) {
    // lengths chosen to create varied content
    const title = genString(rng, 8).trim().replace(/\s+/g,' ').replace(/(^\s+|\s+$)/g,'') || "untitled";
    const author_first = genString(rng, 6).trim().replace(/\s+/g,' ') || "anon";
    const author_last = genString(rng, 7).trim().replace(/\s+/g,' ') || "anon";
    // ISBN: 10 digits deterministic
    let isbn = "";
    for (let i=0;i<10;i++) isbn += Math.floor(rng()*10).toString();
    const year = 1900 + Math.floor(rng() * 126); // 1900..2025
    const summary = (genString(rng, 60).trim() || "Résumé.") ;
    return { title, author_first, author_last, isbn, year, summary };
  }

  // SVG cover generator (white background, black text)
  function coverDataURI(book) {
    const w = 600, h = 900;
    // escape text for xml
    function e(s){ return String(s).replace(/[&<>"']/g, function(c){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&apos;'}[c]; }); }
    const title = e(book.title);
    const author = e(book.author_first + " " + book.author_last);
    const date = e(String(book.year));
    const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='${w}' height='${h}' viewBox='0 0 ${w} ${h}'>
      <rect width='100%' height='100%' fill='white'/>
      <text x='50%' y='38%' font-family='Courier Prime, monospace' font-size='36' text-anchor='middle' fill='black'>${title}</text>
      <text x='50%' y='46%' font-family='Courier Prime, monospace' font-size='20' text-anchor='middle' fill='black'>${author}</text>
      <text x='50%' y='54%' font-family='Courier Prime, monospace' font-size='16' text-anchor='middle' fill='black'>${date}</text>
    </svg>`;
    return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
  }

  // render grid of books
  function renderBooks(seedNumber) {
    const rng = mulberry32(seedNumber);
    const container = document.getElementById('books');
    container.innerHTML = "";
    // generate 10 books
    const books = [];
    for (let i=0;i<10;i++){
      const b = genBook(rng);
      books.push(b);
    }

    // create elements
    for (const b of books) {
      const card = document.createElement('article');
      card.className = 'book-card';
      card.innerHTML = `
        <a class="card-link" href="${b.isbn}.html" aria-label="Ouvrir la page de ${b.title}">
          <img class="cover" src="${coverDataURI(b)}" alt="Couverture du livre ${b.title}">
          <div class="meta">
            <h2 class="book-title">${escapeHtml(b.title)}</h2>
            <p class="book-author">${escapeHtml(b.author_first)} ${escapeHtml(b.author_last)}</p>
            <p class="book-year">${b.year} — ISBN ${b.isbn}</p>
            <p class="book-summary">${escapeHtml(b.summary)}</p>
          </div>
        </a>
      `;
      container.appendChild(card);
    }

    // accessibility helper: focus first link after regen
    const firstLink = container.querySelector('.card-link');
    if (firstLink) firstLink.setAttribute('tabindex','0');
  }

  // small helper to avoid inserting raw HTML text
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, function(c){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c];});
  }

  // events
  document.getElementById('regen').addEventListener('click', () => {
    const seed = parseInt(document.getElementById('seed').value) || 0;
    renderBooks(seed);
  });

  // initial render with default seed
  window.addEventListener('load', () => {
    const seed = parseInt(document.getElementById('seed').value) || 0;
    renderBooks(seed);
  });
  </script>
</body>
</html>
